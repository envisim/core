import { expect, test } from "vitest";
import type * as GJ from "@envisim/geojson-utils/geojson";
import { Circle, FeatureCollection, Polygon } from "../../src/index.js";
import { intersectAreaAreaGeometries } from "../../src/intersect/intersect-area-area.js";

const ag1 = Polygon.create([
  [
    [20.73, 24.84],
    [17.47, 20.47],
    [21.94, 15.08],
    [29.31, 17.06],
    [31.28, 24.45],
    [25.59, 27.94],
    [20.73, 24.84],
  ],
  [
    [26.69, 21.54],
    [25.66, 23.93],
    [28.16, 25.4],
    [30.21, 23.33],
    [26.69, 21.54],
  ],
]);

const ag2 = Polygon.create([
  [
    [30.46, 28.96],
    [23.58, 24.66],
    [26.85, 19.91],
    [34.62, 20.48],
    [33.06, 26.02],
    [30.46, 28.96],
  ],
]);

const intersectPoints: GJ.Position2[][] = [
  [
    [23.58, 24.66],
    [26.85, 19.91],
    [30.133963433480055, 20.15090851442518],
    [31.28, 24.45],
    [27.224222103956006, 26.937638814972505],
  ],
  [
    [26.69, 21.54],
    [25.66, 23.93],
    [28.16, 25.4],
    [30.21, 23.33],
  ],
];

test("intersect polygon-polygon", () => {
  const int = intersectAreaAreaGeometries(ag1, ag2);
  Polygon.assert(int);
  const coords = int.coordinates;
  expect(coords.length).toBe(2);
  expect(coords[0]).toEqual(expect.arrayContaining(intersectPoints[0]));
  expect(coords[1]).toEqual(expect.arrayContaining(intersectPoints[1]));
});

const circles = [
  Circle.create([25.8, 22.4], 10000),
  Circle.create([25.8, 22.4], 60000),
  Circle.create([26.34, 22.67], 10000),
];

test("intersect circle-circle", () => {
  {
    const int = intersectAreaAreaGeometries(circles[0], circles[1]);
    Circle.assert(int);
    delete circles[0].bbox;
    expect(int).toEqual(circles[0]);
  }
  {
    const int = intersectAreaAreaGeometries(circles[2], circles[1]);
    Polygon.assert(int);
  }
});

test("intersect circle-polygon", () => {
  {
    const int = intersectAreaAreaGeometries(ag1, circles[0]);
    Circle.assert(int);
    delete circles[0].bbox;
    expect(int).toEqual(circles[0]);
  }
  {
    const int = intersectAreaAreaGeometries(ag1, circles[1]);
    Polygon.assert(int);
  }
  {
    const int = intersectAreaAreaGeometries(ag1, circles[2]);
    expect(int).toBeNull();
  }
});

test("intersect converted circle-polygon", () => {
  const polygon = Polygon.create([
    [
      [20.383759, 63.800804],
      [20.380669, 63.800037],
      [20.383523, 63.799279],
      [20.386033, 63.800188],
      [20.383759, 63.800804],
    ],
  ]);
  const polycircle = Polygon.create([
    [
      [20.383399244581472, 63.79932128736324],
      [20.383363919580006, 63.79931992104308],
      [20.383329667920844, 63.79931586359794],
      [20.38329753033209, 63.79930923831235],
      [20.383268483304654, 63.799300246493964],
      [20.383243409421233, 63.799289161356754],
      [20.383223070539113, 63.79927631971924],
      [20.38320808464142, 63.79926211177015],
      [20.383198907060574, 63.799246969212575],
      [20.38319581664394, 63.79923135214656],
      [20.38319890728223, 63.79921573508916],
      [20.383208085057994, 63.79920059255636],
      [20.383223071100332, 63.79918638464525],
      [20.38324341005946, 63.799173543054295],
      [20.38326848394285, 63.79916245796663],
      [20.383297530893312, 63.799153466194824],
      [20.38332966833741, 63.799146840947195],
      [20.383363919801653, 63.799142783526825],
      [20.383399244581454, 63.79914141721527],
      [20.38343456936129, 63.799142783526825],
      [20.383468820825534, 63.799146840947195],
      [20.383500958269632, 63.799153466194824],
      [20.383530005220095, 63.79916245796663],
      [20.383555079103484, 63.799173543054295],
      [20.383575418062613, 63.79918638464525],
      [20.38359040410495, 63.79920059255636],
      [20.383599581880713, 63.79921573508916],
      [20.383602672519004, 63.79923135214656],
      [20.38359958210237, 63.799246969212575],
      [20.383590404521524, 63.79926211177015],
      [20.38357541862383, 63.79927631971924],
      [20.38355507974171, 63.799289161356754],
      [20.38353000585829, 63.799300246493964],
      [20.383500958830854, 63.79930923831235],
      [20.3834688212421, 63.79931586359794],
      [20.38343456958294, 63.79931992104308],
      [20.383399244581472, 63.79932128736324],
    ],
  ]);

  const int1 = intersectAreaAreaGeometries(polygon, polycircle);
  expect(int1).not.toBeNull();
});

test("non-overlapping", () => {
  const poly1 = Polygon.create([
    [
      [20.382250571191626, 63.79941345753493],
      [20.38253248161436, 63.799284398430416],
      [20.382824408311265, 63.79940902934919],
      [20.38254249797854, 63.79953808902122],
      [20.382250571191626, 63.79941345753493],
    ],
  ]);
  const poly2 = Polygon.create([
    [
      [20.383759, 63.800804],
      [20.380669, 63.800037],
      [20.383523, 63.799279],
      [20.386033, 63.800188],
      [20.383759, 63.800804],
    ],
  ]);

  const int1 = intersectAreaAreaGeometries(poly1, poly2);
  expect(int1).toBeNull();
});

test("belt-sampling", () => {
  const beltfc = FeatureCollection.createAreaFromJson({
    type: "FeatureCollection",
    features: [
      {
        type: "Feature",
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [20.379457811223013, 63.799513493953775],
              [20.380066232408577, 63.79941559476434],
              [20.380674651619568, 63.79931769573794],
              [20.381283068856014, 63.799219796874574],
              [20.381891484117947, 63.79912189817425],
              [20.38249989740538, 63.79902399963699],
              [20.383108308718363, 63.79892610126279],
              [20.38371671805692, 63.798828203051684],
              [20.384325125421054, 63.79873030500366],
              [20.384933530810812, 63.79863240711873],
              [20.38554193422622, 63.79853450939692],
              [20.386150335667306, 63.79843661183823],
              [20.386758735134087, 63.79833871444267],
              [20.387367132626604, 63.79824081721024],
              [20.387975528144885, 63.798142920140975],
              [20.38858392168894, 63.798045023234884],
              [20.389192313258814, 63.79794712649195],
              [20.38980070285453, 63.79784922991222],
              [20.390409090476115, 63.797751333495654],
              [20.391017476123587, 63.79765343724231],
              [20.39108686932025, 63.797737734567384],
              [20.390478484030048, 63.797835630800805],
              [20.38987009676573, 63.79793352719743],
              [20.38926170752726, 63.79803142375726],
              [20.388653316314624, 63.79812932048027],
              [20.3880449231278, 63.79822721736645],
              [20.387436527966774, 63.7983251144158],
              [20.38682813083148, 63.798423011628316],
              [20.386219731721926, 63.79852090900397],
              [20.385611330638067, 63.79861880654274],
              [20.38500292757989, 63.798716704244654],
              [20.384394522547336, 63.79881460210966],
              [20.383786115540417, 63.798912500137774],
              [20.38317770655906, 63.799010398328974],
              [20.382569295603297, 63.799108296683265],
              [20.381960882673056, 63.799206195200625],
              [20.381352467768306, 63.79930409388105],
              [20.38074405088905, 63.79940199272451],
              [20.38013563203524, 63.79949989173102],
              [20.37952721120686, 63.79959779090054],
              [20.379457811223013, 63.799513493953775],
            ],
          ],
        },
        properties: {
          _designWeight: 5,
        },
      },
      {
        type: "Feature",
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [20.379804815295557, 63.7999349783548],
              [20.380413234695183, 63.79983707926486],
              [20.38102165212021, 63.799739180337966],
              [20.381630067570686, 63.79964128157411],
              [20.38223848104661, 63.79954338297331],
              [20.382846892548024, 63.79944548453558],
              [20.383455302074957, 63.79934758626092],
              [20.384063709627434, 63.79924968814934],
              [20.384672115205476, 63.79915179020085],
              [20.385280518809136, 63.799053892415486],
              [20.3858889204384, 63.79895599479322],
              [20.38649732009334, 63.79885809733409],
              [20.387105717773935, 63.7987602000381],
              [20.387714113480254, 63.79866230290524],
              [20.388322507212308, 63.79856440593556],
              [20.388930898970123, 63.79846650912904],
              [20.389539288753728, 63.7983686124857],
              [20.390147676563156, 63.798270716005554],
              [20.39075606239843, 63.79817281968861],
              [20.391364446259573, 63.79807492353487],
              [20.391433841532578, 63.79815922069355],
              [20.390825458028708, 63.79825711682737],
              [20.390217072550712, 63.79835501312439],
              [20.389608685098555, 63.798452909584626],
              [20.389000295672215, 63.79855080620804],
              [20.38839190427165, 63.79864870299465],
              [20.387783510896845, 63.79874659994442],
              [20.387175115547787, 63.79884449705735],
              [20.38656671822444, 63.79894239433342],
              [20.385958318926743, 63.799040291772656],
              [20.385349917654718, 63.79913818937499],
              [20.38474151440828, 63.799236087140464],
              [20.38413310918748, 63.79933398506903],
              [20.383524701992233, 63.7994318831607],
              [20.38291629282251, 63.79952978141546],
              [20.382307881678322, 63.799627679833286],
              [20.3816994685596, 63.79972557841418],
              [20.381091053466342, 63.799823477158135],
              [20.38048263639852, 63.79992137606512],
              [20.379874217356093, 63.800019275135156],
              [20.379804815295557, 63.7999349783548],
            ],
          ],
        },
        properties: {
          _designWeight: 5,
        },
      },
      {
        type: "Feature",
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [20.38015182975173, 63.80035646192374],
              [20.380760247365316, 63.80025856293333],
              [20.38136866300429, 63.800160664105945],
              [20.38197707666868, 63.80006276544161],
              [20.382585488358508, 63.799964866940336],
              [20.383193898073806, 63.79986696860213],
              [20.383802305814594, 63.799769070427004],
              [20.3844107115809, 63.799671172414975],
              [20.385019115372764, 63.79957327456604],
              [20.3856275171902, 63.799475376880224],
              [20.386235917033254, 63.79937747935752],
              [20.386844314901925, 63.79927958199796],
              [20.387452710796257, 63.79918168480154],
              [20.388061104716275, 63.79908378776827],
              [20.38866949666202, 63.798985890898166],
              [20.389277886633487, 63.79888799419125],
              [20.38988627463074, 63.79879009764749],
              [20.39049466065378, 63.798692201266945],
              [20.391103044702646, 63.798594305049605],
              [20.391711426777356, 63.798496408995476],
              [20.39178082412678, 63.798580705987774],
              [20.39117244240936, 63.79867860202197],
              [20.390564058717786, 63.79877649821939],
              [20.38995567305203, 63.79887439458002],
              [20.389347285412068, 63.79897229110384],
              [20.38873889579787, 63.799070187790846],
              [20.38813050420941, 63.79916808464104],
              [20.38752211064666, 63.799265981654386],
              [20.386913715109593, 63.7993638788309],
              [20.386305317598186, 63.799461776170546],
              [20.385696918112394, 63.79955967367333],
              [20.385088516652214, 63.79965757133924],
              [20.3844801132176, 63.799755469168254],
              [20.38387170780853, 63.79985336716038],
              [20.383263300424986, 63.7999512653156],
              [20.382654891066927, 63.800049163633894],
              [20.38204647973433, 63.80014706211526],
              [20.381438066427165, 63.80024496075969],
              [20.380829651145415, 63.800342859567166],
              [20.380221233889042, 63.80044075853769],
              [20.38015182975173, 63.80035646192374],
            ],
          ],
        },
        properties: {
          _designWeight: 5,
        },
      },
      {
        type: "Feature",
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [20.38049885459201, 63.80077794466061],
              [20.38110727041947, 63.8006800457697],
              [20.38171568427228, 63.80058214704185],
              [20.382324096150494, 63.800484248477034],
              [20.382932506054136, 63.80038635007529],
              [20.383540913983204, 63.80028845183663],
              [20.384149319937762, 63.80019055376105],
              [20.384757723917808, 63.80009265584857],
              [20.385366125923394, 63.79999475809919],
              [20.38597452595453, 63.79989686051293],
              [20.386582924011243, 63.7997989630898],
              [20.38719132009358, 63.79970106582981],
              [20.38779971420155, 63.79960316873296],
              [20.38840810633517, 63.799505271799276],
              [20.389016496494495, 63.799407375028764],
              [20.389624884679538, 63.799309478421435],
              [20.39023327089033, 63.799211581977296],
              [20.39084165512689, 63.799113685696355],
              [20.391450037389248, 63.799015789578625],
              [20.392058417677443, 63.79891789362412],
              [20.39212781710338, 63.799002190450004],
              [20.3915194371725, 63.799100086384584],
              [20.390911055267445, 63.79919798248238],
              [20.390302671388184, 63.79929587874341],
              [20.389694285534702, 63.79939377516762],
              [20.38908589770696, 63.799491671755035],
              [20.38847750790493, 63.79958956850564],
              [20.387869116128588, 63.799687465419396],
              [20.38726072237792, 63.79978536249632],
              [20.38665232665287, 63.799883259736404],
              [20.386043928953427, 63.79998115713961],
              [20.385435529279558, 63.80007905470596],
              [20.38482712763125, 63.80017695243543],
              [20.38421872400847, 63.800274850327995],
              [20.38361031841116, 63.80037274838368],
              [20.383001910839344, 63.800470646602434],
              [20.38239350129297, 63.800568544984266],
              [20.381785089772, 63.80066644352917],
              [20.38117667627642, 63.80076434223712],
              [20.380568260806196, 63.80086224110812],
              [20.38049885459201, 63.80077794466061],
            ],
          ],
        },
        properties: {
          _designWeight: 5,
        },
      },
      {
        type: "Feature",
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [20.38084588981686, 63.80119942656532],
              [20.381454303858096, 63.80110152777394],
              [20.382062715924665, 63.8010036291456],
              [20.382671126016607, 63.800905730680334],
              [20.383279534133955, 63.800807832378126],
              [20.383887940276722, 63.80070993423901],
              [20.384496344444944, 63.80061203626297],
              [20.385104746638635, 63.80051413845005],
              [20.38571314685784, 63.80041624080023],
              [20.38632154510257, 63.80031834331354],
              [20.386929941372866, 63.80022044598998],
              [20.38753833566875, 63.80012254882956],
              [20.388146727990254, 63.80002465183231],
              [20.388755118337393, 63.79992675499821],
              [20.3893635067102, 63.799828858327295],
              [20.38997189310873, 63.79973096181958],
              [20.390580277532962, 63.799633065475035],
              [20.391188659982948, 63.79953516929371],
              [20.39179704045872, 63.79943727327561],
              [20.392405418960287, 63.79933937742073],
              [20.39247482046284, 63.7994236740802],
              [20.391866442318598, 63.79952156991516],
              [20.39125806220015, 63.79961946591334],
              [20.390649680107494, 63.799717362074745],
              [20.39004129604057, 63.79981525839935],
              [20.389432909999393, 63.799913154887165],
              [20.388824521983896, 63.800011051538156],
              [20.38821613199405, 63.80010894835233],
              [20.387607740029864, 63.80020684532967],
              [20.386999346091276, 63.80030474247017],
              [20.386390950178278, 63.800402639773814],
              [20.38578255229083, 63.800500537240595],
              [20.385174152428917, 63.80059843487049],
              [20.384565750592504, 63.800696332663506],
              [20.383957346781564, 63.80079423061962],
              [20.38334894099608, 63.80089212873884],
              [20.382740533236003, 63.80099002702113],
              [20.382132123501318, 63.80108792546649],
              [20.381523711792006, 63.801185824074935],
              [20.380915298108025, 63.80128372284641],
              [20.38084588981686, 63.80119942656532],
            ],
          ],
        },
        properties: {
          _designWeight: 5,
        },
      },
    ],
  });

  // LEFT
  const poly1 = Polygon.create([
    [
      [20.383759, 63.800804],
      [20.380669, 63.800037],
      [20.383523, 63.799279],
      [20.386033, 63.800188],
      [20.383759, 63.800804],
    ],
  ]);

  // RIGHT
  const poly2 = Polygon.create([
    [
      [20.386591, 63.800056],
      [20.384381, 63.799156],
      [20.389574, 63.797905],
      [20.391076, 63.799118],
      [20.386591, 63.800056],
    ],
  ]);

  const leftInt = beltfc.features.map(
    (f) => intersectAreaAreaGeometries(poly1, f.geometry) === null,
  );
  expect(leftInt).toEqual([true, false, false, false, false]);

  const rightInt = beltfc.features.map(
    (f) => intersectAreaAreaGeometries(poly2, f.geometry) === null,
  );
  expect(rightInt).toEqual([false, false, false, false, true]);
});
